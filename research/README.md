# Dissecting ERC721 Storage

_NOTE_: Be sure to run through all tools' README to set them up.

#### Running Frontier Node

```shell
cd frontier/
./target/release/frontier-template-node --log evm=trace --dev --sealing instant
```

#### Deploying and minting some NFTs

```shell
cd nft-solidity/
npx hardhat console --network frontier
```
 - Once you get the Hardhat console ready, copy and paste the following lines there:

```shell
const [owner, other] = await ethers.getSigners();
const alice = '0xd43593c715fdd31c61141abd04a99fd6822c8558';
const bob = '0x8eaf04151687736326c9fea17e25fc5287613693';

const TestToken2 = await ethers.getContractFactory("TestToken2");
let testToken2 = await TestToken2.deploy(alice, "MyToken2", "MTK2");

// Contract Address should be 0xC2Bf5F29a4384b1aB0C063e1c666f02121B6084a

let m1 = await testToken2.mintTo(alice, '0x0000000000000000000000000000000000000000000000000000000000000111');
let m2 = await testToken2.mintTo(alice, '0x0000000000000000000000000000000000000000000000000000000000000222');
let m3 = await testToken2.mintTo(alice, '0x0000000000000000000000000000000000000000000000000000000000000333');
let m4 = await testToken2.mintTo(bob, '0x0000000000000000000000000000000000000000000000000000000000000777');
let m5 = await testToken2.mintTo(bob, '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff');

// <CTRL+D to exit>
```

#### Inspecting EVM Storage using Python's `substorage`

```shell
cd storage-visualizer/python
python3 substorage
```

The `substorage` output shows `key -> value` storage of `0xC2Bf5F29a4384b1aB0C063e1c666f02121B6084a` contract.

_NOTE_: All comments (`//`) were added to better understand how EVM storage works.

```shell
0x0000000000000000000000000000000000000000000000000000000000000002 -> 0x0000000000000000000000000000000000000000000000000000000000000005 // key[2]: mapping length

0x0000000000000000000000000000000000000000000000000000000000000006 -> 0x4d79546f6b656e32000000000000000000000000000000000000000000000010 // name ("MyToken2")
0x0000000000000000000000000000000000000000000000000000000000000007 -> 0x4d544b3200000000000000000000000000000000000000000000000000000008 // symbol ("MTK2")
0x000000000000000000000000000000000000000000000000000000000000000a -> 0x000000000000000000000000d43593c715fdd31c61141abd04a99fd6822c8558 // owner (alice)

0x20710070f4d1b979e34bd17faad8e857cc089f32123767b394ca89e2360b5af1 -> 0x0000000000000000000000000000000000000000000000000000000000000003
0x264d15b6b58797709a278a4c2cf72caa64e36a3d0daa34fcf5f3f9c841853d33 -> 0x0000000000000000000000000000000000000000000000000000000000000002

0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace -> 0x0000000000000000000000000000000000000000000000000000000000000111 // keccak(key[2])
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5acf -> 0x000000000000000000000000d43593c715fdd31c61141abd04a99fd6822c8558 // +1
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad0 -> 0x0000000000000000000000000000000000000000000000000000000000000222 // +2
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad1 -> 0x000000000000000000000000d43593c715fdd31c61141abd04a99fd6822c8558 // ...
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad2 -> 0x0000000000000000000000000000000000000000000000000000000000000333 // ...
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad3 -> 0x000000000000000000000000d43593c715fdd31c61141abd04a99fd6822c8558 // ...
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad4 -> 0x0000000000000000000000000000000000000000000000000000000000000777 // ...
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad5 -> 0x0000000000000000000000008eaf04151687736326c9fea17e25fc5287613693 // ...
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad6 -> 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff // ...
0x405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad7 -> 0x0000000000000000000000008eaf04151687736326c9fea17e25fc5287613693 // +9

0x425b867e563b14348de1a086d84330bf8ccd2959f6a5138a1d0f7e5bbb44ed5e -> 0x0000000000000000000000000000000000000000000000000000000000000004
0x5cdeb6827439cd3029ee923d5104437bb5fcf4b37fe49c85579c604461b3422c -> 0x0000000000000000000000000000000000000000000000000000000000000002
0x6467f1319ac5e64408f3a78a5861221e71dd11215ecce51631d602a0746eba6e -> 0x0000000000000000000000000000000000000000000000000000000000000001
0x6764135694a1d11024b6d684e90ab112de28cbdbda4938e40cade9aba7f03990 -> 0x0000000000000000000000000000000000000000000000000000000000000003
0x67be87c3ff9960ca1e9cfac5cab2ff4747269cf9ed20c9b7306235ac35a491c5 -> 0x0000000000000000000000000000000000000000000000000000000000000001
0x77b7bbe0e49b76487c9476b5db3354cf5270619d0037ccb899c2a4c4a75b4318 -> 0x0000000000000000000000000000000000000000000000000000000000000001

0x811b3bf8d55eda8dcde11b15ac71a2373436fc7e07a88ceb51b73383051ee4fb -> 0x0000000000000000000000000000000000000000000000000000000000000777 // keccak(keccak(bob, 1))
0x811b3bf8d55eda8dcde11b15ac71a2373436fc7e07a88ceb51b73383051ee4fc -> 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff // +1

0x8ae71821897c61a091b322b4ff61a0954e0e03834fb81aa7de287374f8e4abda -> 0x0000000000000000000000000000000000000000000000000000000000000003 // keccak(alice, 1): tokens

0x9562381dfbc2d8b8b66e765249f330164b73e329e5f01670660643571d1974df -> 0x0000000000000000000000000000000000000000000000000000000000000001
0x9c68d7404ea71965a39260214a95ed0602bd38a9bb003aaff75f9fef6859368a -> 0x0000000000000000000000000000000000000000000000000000000000000002

0xa1562e72bd7da7d0ba02d21e86cab259e17e8f3bb58c612da38da1d9348925dc -> 0x0000000000000000000000000000000000000000000000000000000000000111 // keccak(keccak(alice, 1))
0xa1562e72bd7da7d0ba02d21e86cab259e17e8f3bb58c612da38da1d9348925dd -> 0x0000000000000000000000000000000000000000000000000000000000000222 // +1
0xa1562e72bd7da7d0ba02d21e86cab259e17e8f3bb58c612da38da1d9348925de -> 0x0000000000000000000000000000000000000000000000000000000000000333 // +2

0xa46d51750262da2b56a9c58bcff96513da306f8f74ea19d788eb0a4e908807e2 -> 0x0000000000000000000000000000000000000000000000000000000000000001
0xb1ee3b3d0d99532dd9f14b22c0b908d4eec0e052c3827bbed2d6c3986954d08c -> 0x0000000000000000000000000000000000000000000000000000000000000005
0xb63f0fc883b73eef10e2b8f235c8decef790391dc72f645ab07c05273d60d627 -> 0x0000000000000000000000000000000000000000000000000000000000000001

0xbe44d2a53e2cafa01e969663a17f198453d8e74a2b61115b3407ed42fbc997fb -> 0x0000000000000000000000000000000000000000000000000000000000000002 // keccak(bob, 1): tokens

0xf7815fccbf112960a73756e185887fedcb9fc64ca0a16cc5923b7960ed780800 -> 0x0000000000000000000000000000000000000000000000000000000000000001
```

As we can see for the `nft-solidity/contracts/NFT2.sol` contract, the `mapping(uint256 => address)` is at storage slot `2`.

If we use keccak on it, we'll have the mapping's first entry (`keccak(0x00...02)`) and its value is `0x00...111`, a tokenId (`uing256`).
Adding one (+1) to that first keccak hash will give us the owner (`address`) of that tokenId.

So, the migration here (and for all simple ERC721 implementations) can be done by `sudo` calling `migrate_erc721_nfts()` from `pallet_migrate`.

What `migrate_erc721_nfts()` does is:

1. Create a Uniques `Collection` with ERC721 Contract Address as its id.
2. Loop through all those storage entries, creating an `Item` for each tokenId and setting it owner by using the `pallet_evm` mapping (`AddressMapping`) to translate the owner EVM account address to a Substrate `AccountId`.

So, at this point, we should have all ERC721 tokens migrated to Uniques' pallet.

#### AccountId and EVM Address:

Here we have a first challenge, as translating EVM Address to Substrate AccountId is not trivial, eg:

- `Alice` AccountId is `5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY`
- `Alice` EVM account address is set to be the first 20 bytes of its public key: `0xd43593c715fdd31c61141abd04a99fd6822c8558`
- But there is no way to get back to `Alice` AccountId by having only her EVM account address!
- If we use `AddressMapping` to get an AccountId from `0xd43593c715fdd31c61141abd04a99fd6822c8558`, we'll end up with `5FrLxJsyJ5x9n2rmxFwosFraxFCKcXZDngRLNectCn64UjtZ` (not `Alice`).

##### Ideas:

1. One approach (used by `pallet_migrate` `claim_erc721_items()`) is to allow "real" `Alice` (`5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY`) to claim ownership of all items that was minted to `5FrLxJsyJ5x9n2rmxFwosFraxFCKcXZDngRLNectCn64UjtZ`.

2. Another approach would be creating a `Storage` mapping (`H160` -> `AccountId`) and populate it by asking users to sign a message with their EVM accounts (`H160`) and submit the signature in an extrinsic with their `AccountId`. That way we'll be able to state that a given user controls an EVM Address.
